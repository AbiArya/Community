# Current Supabase Database Schema Snapshot
**Captured:** 2025-11-27  
**Purpose:** Reference for AWS RDS migration

## Tables Overview

### 1. users
PostgreSQL table with PostGIS extension for geographic queries.

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR UNIQUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  full_name VARCHAR,
  bio TEXT,
  location VARCHAR,  -- Deprecated: use zipcode instead
  zipcode VARCHAR(10),
  latitude DECIMAL(10, 8),
  longitude DECIMAL(11, 8),
  location_point GEOGRAPHY(POINT, 4326),  -- PostGIS for distance queries
  age INTEGER,
  is_profile_complete BOOLEAN DEFAULT false,
  last_active TIMESTAMPTZ,
  match_frequency INTEGER DEFAULT 2,
  age_range_min INTEGER DEFAULT 18,
  age_range_max INTEGER DEFAULT 100,
  distance_radius INTEGER DEFAULT 50
);

-- Indexes
CREATE INDEX idx_users_zipcode ON users(zipcode);
CREATE INDEX idx_users_location_point ON users USING GIST(location_point);
CREATE INDEX idx_users_is_profile_complete ON users(is_profile_complete);
```

### 2. user_photos
Stores photo URLs (currently Supabase Storage, will migrate to S3).

```sql
CREATE TABLE user_photos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  photo_url VARCHAR NOT NULL,
  storage_path VARCHAR,  -- Added for S3 migration tracking
  display_order INTEGER NOT NULL DEFAULT 0,
  is_primary BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_user_photos_user_id ON user_photos(user_id);
CREATE INDEX idx_user_photos_display_order ON user_photos(user_id, display_order);
```

### 3. hobbies
Predefined list of hobbies/interests.

```sql
CREATE TABLE hobbies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR UNIQUE NOT NULL,
  category VARCHAR,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Initial seed data includes ~50 hobbies across categories:
-- Sports, Creative Arts, Outdoor Activities, Food & Drink, etc.
```

### 4. user_hobbies
Junction table with ranking for user preferences.

```sql
CREATE TABLE user_hobbies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  hobby_id UUID REFERENCES hobbies(id) ON DELETE CASCADE,
  preference_rank INTEGER NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, hobby_id)
);

-- Indexes
CREATE INDEX idx_user_hobbies_user_id ON user_hobbies(user_id);
CREATE INDEX idx_user_hobbies_hobby_id ON user_hobbies(hobby_id);
CREATE INDEX idx_user_hobbies_rank ON user_hobbies(user_id, preference_rank);
```

### 5. matches
Weekly friend matches generated by algorithm.

```sql
CREATE TABLE matches (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_1_id UUID REFERENCES users(id) ON DELETE CASCADE,
  user_2_id UUID REFERENCES users(id) ON DELETE CASCADE,
  similarity_score FLOAT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  match_week VARCHAR NOT NULL,  -- Format: '2024-W01'
  is_viewed_by_user_1 BOOLEAN DEFAULT false,
  is_viewed_by_user_2 BOOLEAN DEFAULT false,
  CONSTRAINT unique_match UNIQUE(user_1_id, user_2_id, match_week)
);

-- Indexes
CREATE INDEX idx_matches_user_1 ON matches(user_1_id);
CREATE INDEX idx_matches_user_2 ON matches(user_2_id);
CREATE INDEX idx_matches_week ON matches(match_week);
CREATE INDEX idx_matches_score ON matches(similarity_score DESC);
```

### 6. conversations (Planned for Phase 6.3)
```sql
CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  match_id UUID REFERENCES matches(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  last_message_at TIMESTAMPTZ,
  last_message_preview TEXT
);
```

### 7. messages (Planned for Phase 6.3)
```sql
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
  sender_id UUID REFERENCES users(id) ON DELETE CASCADE,
  receiver_id UUID REFERENCES users(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  message_type VARCHAR DEFAULT 'text',  -- 'text', 'image', 'system'
  is_read BOOLEAN DEFAULT false,
  read_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  deleted_by_sender BOOLEAN DEFAULT false,
  deleted_by_receiver BOOLEAN DEFAULT false
);

-- Indexes
CREATE INDEX idx_messages_conversation ON messages(conversation_id, created_at DESC);
CREATE INDEX idx_messages_sender ON messages(sender_id);
```

## PostGIS Functions

### get_matching_candidates
Used by matching algorithm to find potential matches within distance radius.

```sql
CREATE OR REPLACE FUNCTION get_matching_candidates(
  p_user_id UUID,
  p_max_distance_miles INTEGER DEFAULT 50
)
RETURNS TABLE (
  candidate_id UUID,
  distance_miles FLOAT
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    u.id AS candidate_id,
    ST_Distance(
      (SELECT location_point FROM users WHERE id = p_user_id),
      u.location_point
    )::geography / 1609.34 AS distance_miles
  FROM users u
  WHERE u.id != p_user_id
    AND u.is_profile_complete = true
    AND u.location_point IS NOT NULL
    AND ST_DWithin(
      (SELECT location_point FROM users WHERE id = p_user_id),
      u.location_point,
      (p_max_distance_miles * 1609.34)::float
    );
END;
$$ LANGUAGE plpgsql;
```

## Row Level Security (RLS) Policies

**Important:** AWS RDS doesn't support RLS. These policies must be reimplemented in application layer (Phase 8).

### users table
- Users can read all profiles (for matching)
- Users can only update their own profile
- Users can only insert their own profile

### user_photos table
- Users can read all photos (for viewing matches)
- Users can only insert/update/delete their own photos

### matches table
- Users can only read matches where they are user_1 or user_2
- Only backend can insert matches (via service role)

### user_hobbies table
- Users can read all hobbies (for matching)
- Users can only insert/update/delete their own hobbies

## Migration Notes

1. **PostGIS Extension**: Must be enabled in RDS: `CREATE EXTENSION postgis;`
2. **UUID Generation**: RDS supports `gen_random_uuid()` natively
3. **TIMESTAMPTZ**: Fully supported in RDS PostgreSQL
4. **RLS Replacement**: Implement authorization checks in Lambda functions
5. **Storage Paths**: `storage_path` column added for S3 migration tracking
6. **Supabase Auth**: User IDs from Supabase auth.users will be mapped to Cognito

## Data Export Checklist (Phase 1.3)

- [ ] Export users table (excluding auth-specific fields)
- [ ] Export user_photos (will need to migrate S3 URLs)
- [ ] Export hobbies (predefined seed data)
- [ ] Export user_hobbies
- [ ] Export matches
- [ ] Backup Supabase Storage photos

## Estimated Data Volume (as of 2025-11-27)
- Users: [TODO: Count before migration]
- Photos: [TODO: Count before migration]
- Matches: [TODO: Count before migration]
- Storage: [TODO: Calculate size before migration]

